<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        html, body {
            height: 100%;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="canvas3d"></canvas>
    <div id="song-analysis-container" style="padding: 20px;"></div>
    <div id="fashion-container" style="padding: 20px;"></div> <!-- Container for DALL-E generated images -->

<script type="module">
  import { Application } from '/static/js/runtime.js';

  const canvas = document.getElementById('canvas3d');
  const app = new Application(canvas);

  app.load('/static/scenes/scene.splinecode').then(() => {
      app.addEventListener('mouseDown', (e) => {
          if (e.target.name === 'music-hotspot') {
              fetch('/top-songs')
                  .then(response => response.json())
                  .then(songs => {
                      let songListHtml = songs.map((song, index) => `
                          ${index + 1}. ${song.track_name} by ${song.artist_name}<br>
                      `).join('');
                      Swal.fire({
                          title: 'Your Top Songs',
                          html: `<div>${songListHtml}</div>`,
                          showCloseButton: true,
                          focusConfirm: false
                      });
                  })
                  .catch(error => console.error('Error fetching top songs:', error));
          } else if (e.target.name === 'coffee-hotspot') {
              analyzeAllSongs();
          } else if (e.target.name === 'fasion-hotspot') {
              getOutfits();
          }
      });
  });

  function analyzeAllSongs() {
      fetch('/top-songs')
          .then(response => response.json())
          .then(songs => {
              Promise.all(songs.map((song, index) =>
                  fetch(`/song-analysis?songIndex=${index}`)
              ))
              .then(responses => Promise.all(responses.map(res => res.json())))
              .then(allData => {
                  let allAnalysisHTML = allData.map((data, index) => `
                      <div style="margin-top: 20px;">
                          <h3>Analysis for ${songs[index].track_name} by ${songs[index].artist_name}:</h3>
                          <p>${data.description}</p>
                      </div>
                  `).join('');
                  Swal.fire({
                      title: 'Song Analyses',
                      html: `<div>${allAnalysisHTML}</div>`,
                      showCloseButton: true,
                      focusConfirm: false
                  });
              });
          })
          .catch(error => console.error('Error in song analysis:', error));
  }

  function getOutfits() {
    fetch('/top-songs')
        .then(response => response.json())
        .then(songs => {
            // Gather descriptions for all songs
            return Promise.all(
                songs.map((song, index) => 
                    fetch(`/song-analysis?songIndex=${index}`)
                        .then(response => response.json())
                        .then(data => data.description)
                )
            );
        })
        .then(descriptions => {
            // Send descriptions to generate outfit images in batch
            return fetch('/generate-outfit-images', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ descriptions })
            });
        })
        .then(response => response.json())
        .then(allImagesData => {
            // Create HTML for all the images
            let allImagesHTML = allImagesData.map((imageData, index) => `
                <div style="margin-bottom: 20px;">
                    <h4>Outfit for ${index + 1}:</h4>
                    ${imageData.image_url ? `<img src="${imageData.image_url}" alt="Generated Fashion Image" style="width: auto; max-height: 400px;">` : `<p>Error: ${imageData.error}</p>`}
                </div>
            `).join('');

            Swal.fire({
                title: 'Generated Fashion for All Songs',
                html: `<div>${allImagesHTML}</div>`,
                showCloseButton: true,
                focusConfirm: false
            });
        })
  }

</script>
